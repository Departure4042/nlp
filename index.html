<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Cost Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/preact/10.17.0/preact.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #total-cost, #timer {
            font-size: 24px;
            font-weight: bold;
            color: #e44d26;
        }
        .projection, .savings {
            font-size: 18px;
        }
        #share-link {
            margin-top: 20px;
            display: flex;
            align-items: center;
        }
        #copy-button {
            margin-left: 10px;
            cursor: pointer;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="app"></div>

<script>
    const { h, Component, render } = preact;

    class App extends Component {
        state = {
            employeeData: [],
            selectedEmployees: [],
            totalCost: 0,
            costPerMinute: 0,
            meetingInterval: null,
            startTime: null,
            elapsedSeconds: 0,
            shareableLink: ''
        };

        async componentDidMount() {
            try {
                const response = await fetch('napa-2022.csv');
                const csvText = await response.text();
                const employeeData = this.csvToObjects(csvText);
                this.setState({ employeeData });
                this.preselectAttendeesFromURL();
            } catch (error) {
                console.error('Error in fetching and parsing CSV data:', error);
            }
        }

        csvToObjects(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const data = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = data[index];
                    return obj;
                }, {});
            });
        }

        formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const sec = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        updateMeetingCost = () => {
            const elapsedSeconds = Math.floor((Date.now() - this.state.startTime) / 1000);
            const totalCost = this.state.totalCost + (this.state.costPerMinute / 60);
            this.setState({ totalCost, elapsedSeconds });
        };

        startMeeting = () => {
            const attendees = this.state.selectedEmployees.map(index => this.state.employeeData[index]);
            const costPerMinute = attendees.reduce((sum, attendee) => sum + parseFloat(attendee['Base Pay']) / (52 * 40 * 60), 0);
            const meetingInterval = setInterval(this.updateMeetingCost, 1000); // Update every second
            this.setState({ costPerMinute, meetingInterval, startTime: Date.now() });
        };

        stopMeeting = () => {
            clearInterval(this.state.meetingInterval);
            this.setState({ meetingInterval: null });
        };

        resetCalculator = () => {
            clearInterval(this.state.meetingInterval);
            this.setState({
                totalCost: 0,
                costPerMinute: 0,
                selectedEmployees: [],
                meetingInterval: null,
                startTime: null,
                elapsedSeconds: 0
            });
        };

        generateShareableLink = () => {
            const baseUrl = window.location.href.split('?')[0];
            const queryParams = this.state.selectedEmployees.map(index => `attendee=${index}`).join('&');
            const shareableLink = `${baseUrl}?${queryParams}`;
            this.setState({ shareableLink });
        };

        preselectAttendeesFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const selectedEmployees = urlParams.getAll('attendee').map(index => parseInt(index, 10));
            this.setState({ selectedEmployees }, this.generateShareableLink);
        }

        handleEmployeeSelectChange = (event) => {
            const selectedEmployees = Array.from(event.target.options)
                .filter(option => option.selected)
                .map(option => parseInt(option.value, 10));
            this.setState({ selectedEmployees }, this.generateShareableLink);
        };

        render(_, state) {
            return (
                h('div', null, 
                    h('h1', null, 'Meeting Cost Calculator'),
                    h('label', { for: 'employee-select' }, 'Select Meeting Attendees:'),
                    h('select', { id: 'employee-select', style: { width: '50%' }, multiple: true, onChange: this.handleEmployeeSelectChange, value: state.selectedEmployees },
                        state.employeeData.map((employee, index) => 
                            h('option', { value: index }, employee['Employee Name'])
                        )
                    ),
                    h('h2', null, 'Total cost of this meeting:'),
                    h('div', { id: 'total-cost' }, `$${state.totalCost.toFixed(2)}`),
                    h('h2', null, 'Elapsed Time:'),
                    h('div', { id: 'timer' }, this.formatTime(state.elapsedSeconds)),
                    h('h3', null, 'Projected Costs:'),
                    h('div', { class: 'projection' }, `Cost if 15 minutes: $${(state.costPerMinute * 15).toFixed(2)}`),
                    h('div', { class: 'projection' }, `Cost if 30 minutes: $${(state.costPerMinute * 30).toFixed(2)}`),
                    h('div', { class: 'projection' }, `Cost if 60 minutes: $${(state.costPerMinute * 60).toFixed(2)}`),
                    h('h3', null, 'Potential Savings:'),
                    h('div', { class: 'savings' }, `If ended 5 minutes early: $${(state.costPerMinute * 5).toFixed(2)}`),
                    h('div', { class: 'savings' }, `If ended 10 minutes early: $${(state.costPerMinute * 10).toFixed(2)}`),
                    h('div', { class: 'savings' }, `If ended 15 minutes early: $${(state.costPerMinute * 15).toFixed(2)}`),
                    h('button', { onClick: this.startMeeting }, 'Start Meeting'),
                    h('button', { onClick: this.stopMeeting }, 'Stop Meeting'),
                    h('button', { onClick: this.resetCalculator }, 'Reset Calculator'),
                    h('div', { id: 'share-link' },
                        h('span', null, 'Share Link: '),
                        h('input', { type: 'text', id: 'shareable-link', readonly: true, value: state.shareableLink }),
                        h('button', { id: 'copy-button', 'data-clipboard-target': '#shareable-link' }, 'Copy Link')
                    ),
                    h('h2', null, 'Data Source:'),
                    h('p', null,
                        'Employee salary data sourced from ',
                        h('a', { href: 'https://transparentcalifornia.com/salaries/2022/napa/', target: '_blank', rel: 'noopener noreferrer' },
                            'Transparent California'
                        ),
                        '.'
                    ),
                    h('h2', null, 'Download Data:'),
                    h('p', null,
                        h('a', { href: 'napa-2022.csv', download: true },
                            'Download the Napa 2022 Employee Salary Data (CSV)'
                        )
                    )
                )
            );
        }
    }

    render(h(App), document.getElementById('app'));
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script>
    new ClipboardJS('#copy-button');
</script>

</body>
</html>
